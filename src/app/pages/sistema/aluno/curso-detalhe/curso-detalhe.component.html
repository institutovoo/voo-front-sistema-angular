<app-sistema-layout [usuario]="usuario" tipoUsuario="aluno" conteudoMaxWidth="1400px">
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a routerLink="/aluno/meus-cursos" class="breadcrumb__link">
      <app-header-icone nome="seta-esquerda" [tamanho]="16"></app-header-icone>
      Meus cursos
    </a>
    <span class="breadcrumb__separator">/</span>
    <span class="breadcrumb__atual">{{ curso.titulo }}</span>
  </div>

  <div class="curso-detalhe">
    <!-- Coluna Principal -->
    <div class="curso-detalhe__principal">
      <!-- Header do Curso -->
      <div class="curso-header">
        <div class="curso-header__video">
          <img [src]="curso.imagem" [alt]="curso.titulo" class="curso-header__thumb" />
          <button class="curso-header__play" (click)="continuarCurso()">
            <app-header-icone nome="play" [tamanho]="32"></app-header-icone>
          </button>
        </div>
      </div>

      <!-- Info Mobile (só aparece em mobile) -->
      <div class="curso-info-mobile">
        <span class="curso-info-mobile__categoria" [style.background-color]="curso.categoriaColor">
          {{ curso.categoria }}
        </span>
        <h1 class="curso-info-mobile__titulo">{{ curso.titulo }}</h1>
        <p class="curso-info-mobile__descricao">{{ curso.descricao }}</p>

        <div class="curso-info-mobile__stats">
          <span class="stat">
            <app-header-icone
              nome="star"
              [tamanho]="16"
              preenchimento="#f59e0b"
              cor="none"
            ></app-header-icone>
            {{ curso.avaliacao }} ({{ curso.totalAvaliacoes }} avaliações)
          </span>
          <span class="stat">
            <app-header-icone nome="usuarios" [tamanho]="16"></app-header-icone>
            {{ curso.totalAlunos | number }} alunos
          </span>
        </div>
      </div>

      <!-- Progresso do Curso -->
      <div class="curso-progresso" *ngIf="inscrito()">
        <div class="curso-progresso__header">
          <h3>Seu progresso</h3>
          <span class="curso-progresso__percent">{{ progresso }}% concluído</span>
        </div>
        <app-barra-progresso
          [valor]="progresso"
          tamanho="medio"
          [cor]="progresso === 100 ? '#22c55e' : '#21b7cd'"
        ></app-barra-progresso>
        <p class="curso-progresso__info">
          {{ totalAulasConcluidas }} de {{ totalAulas }} aulas concluídas
        </p>
      </div>

      <!-- Sobre o Curso -->
      <section class="secao-detalhe">
        <h2 class="secao-detalhe__titulo">Sobre este curso</h2>
        <div class="secao-detalhe__conteudo">
          <p>{{ curso.descricao }}</p>
        </div>
      </section>

      <!-- Lista de Módulos -->
      <div class="modulos">
        <h2 class="modulos__titulo">Conteúdo do curso</h2>
        <p class="modulos__subtitulo">
          {{ curso.modulos.length }} módulos • {{ totalAulas }} aulas • {{ curso.duracao }} de
          conteúdo
        </p>

        <div class="modulos__lista">
          <div
            *ngFor="let modulo of curso.modulos; let i = index"
            class="modulo"
            [class.modulo--expandido]="modulo.expandido"
            [class.modulo--concluido]="isModuloConcluido(modulo)"
          >
            <!-- Header do Módulo -->
            <button class="modulo__header" (click)="toggleModulo(modulo)">
              <div class="modulo__info">
                <span
                  class="modulo__numero"
                  [class.modulo__numero--concluido]="isModuloConcluido(modulo)"
                  [class.modulo__numero--em-progresso]="
                    !isModuloConcluido(modulo) && getAulasConcluidas(modulo) > 0
                  "
                >
                  <app-header-icone
                    *ngIf="isModuloConcluido(modulo)"
                    nome="check"
                    [tamanho]="14"
                    cor="#fff"
                  ></app-header-icone>
                  <span *ngIf="!isModuloConcluido(modulo)">{{ i + 1 }}</span>
                </span>
                <div class="modulo__texto">
                  <h4 class="modulo__titulo">{{ modulo.titulo }}</h4>
                  <span class="modulo__meta">
                    {{ getAulasConcluidas(modulo) }}/{{ modulo.aulas.length }} aulas concluídas
                  </span>
                </div>
              </div>
              <app-header-icone
                [nome]="modulo.expandido ? 'seta-cima' : 'seta-baixo'"
                [tamanho]="20"
              ></app-header-icone>
            </button>

            <!-- Lista de Aulas -->
            <div class="modulo__aulas" *ngIf="modulo.expandido">
              <div
                *ngFor="let aula of modulo.aulas"
                class="aula"
                [class.aula--concluida]="aula.concluida"
                [class.aula--bloqueada]="aula.bloqueada"
                (click)="acessarAula(aula)"
              >
                <span class="aula__icone" [class.aula__icone--concluida]="aula.concluida">
                  <app-header-icone
                    [nome]="getAulaIcone(aula)"
                    [tamanho]="16"
                    [cor]="aula.concluida ? '#22c55e' : '#64748b'"
                  ></app-header-icone>
                </span>
                <span class="aula__titulo">{{ aula.titulo }}</span>
                <span class="aula__duracao">{{ aula.duracao }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Avaliações do Curso -->
      <section class="secao-detalhe">
        <div class="secao-detalhe__header">
          <h2 class="secao-detalhe__titulo">Avaliações</h2>
          <div class="header-rating" *ngIf="curso.totalAvaliacoes > 0">
            <span class="nota">{{ curso.avaliacao }}</span>
            <div class="stars">
              <app-header-icone *ngFor="let s of [1,2,3,4,5]" nome="star" [tamanho]="16" [preenchimento]="s <= curso.avaliacao ? '#f59e0b' : 'none'" [cor]="s <= curso.avaliacao ? 'none' : '#cbd5e1'"></app-header-icone>
            </div>
            <span class="total">({{ curso.totalAvaliacoes }} avaliações)</span>
          </div>
        </div>

        <!-- Formulário de Avaliação (Só se estiver inscrito) -->
        <div class="feedback-form" *ngIf="inscrito() && !avaliacaoEnviada">
          <h3>O que você está achando do curso?</h3>
          <p>Sua opinião é muito importante para nós e para outros alunos.</p>
          
          <div class="rating-input">
            <button *ngFor="let s of [1,2,3,4,5]" (click)="setNota(s)" class="star-btn">
              <app-header-icone 
                nome="star" 
                [tamanho]="32" 
                [preenchimento]="s <= novaNota ? '#f59e0b' : 'none'" 
                [cor]="s <= novaNota ? 'none' : '#cbd5e1'"
              ></app-header-icone>
            </button>
          </div>

          <textarea 
            [(ngModel)]="novoComentario" 
            placeholder="Conte-nos mais sobre sua experiência..."
            rows="4"
          ></textarea>

          <button 
            class="btn btn--primary" 
            (click)="enviarAvaliacao()" 
            [disabled]="novaNota === 0 || !novoComentario.trim()"
          >
            Enviar avaliação
          </button>
        </div>

        <div class="feedback-sucesso" *ngIf="avaliacaoEnviada">
          <app-header-icone nome="check-circle" [tamanho]="48" cor="#22c55e"></app-header-icone>
          <h3>Obrigado pelo seu feedback!</h3>
          <p>Sua avaliação foi enviada com sucesso.</p>
        </div>

        <!-- Lista de Avaliações -->
        <div class="avaliacoes-lista">
          <div *ngFor="let item of avaliacoesMock" class="avaliacao-item">
            <div class="avaliacao-item__header">
              <div class="aluno-avatar">{{ item.aluno.charAt(0) }}</div>
              <div class="aluno-meta">
                <span class="aluno-nome">{{ item.aluno }}</span>
                <span class="avaliacao-data">{{ item.data | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="stars">
                <app-header-icone *ngFor="let s of getStars(item.nota)" nome="star" [tamanho]="14" preenchimento="#f59e0b" cor="none"></app-header-icone>
              </div>
            </div>
            <p class="comentario">{{ item.comentario }}</p>
            
            <div class="resposta-instrutor" *ngIf="item.resposta">
              <div class="resposta-header">
                <app-header-icone nome="mensagem" [tamanho]="14"></app-header-icone>
                <span>Resposta do Instrutor:</span>
              </div>
              <p>{{ item.resposta }}</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Sugestões -->
      <section class="secao-detalhe sugestoes">
        <h2 class="secao-detalhe__titulo">Cursos que você também pode gostar</h2>
        <div class="sugestoes__grid">
          <div *ngFor="let sugestao of sugestoes" class="sugestao-card">
            <div class="sugestao-card__imagem">
              <img [src]="sugestao.imagem" [alt]="sugestao.titulo" />
              <span class="sugestao-card__tag" *ngIf="sugestao.gratuito">Gratuito</span>
            </div>
            <div class="sugestao-card__info">
              <h3 class="sugestao-card__titulo">{{ sugestao.titulo }}</h3>
              <p class="sugestao-card__instrutor">{{ sugestao.instrutor }}</p>
              <div class="sugestao-card__meta">
                <span class="stat">
                  <app-header-icone
                    nome="estrela"
                    [tamanho]="14"
                    preenchimento="#f59e0b"
                    cor="none"
                  ></app-header-icone>
                  {{ sugestao.avaliacao }}
                </span>
                <span class="stat">
                  <app-header-icone nome="usuarios" [tamanho]="14"></app-header-icone>
                  {{ sugestao.totalAlunos }}
                </span>
              </div>
              <div class="sugestao-card__footer">
                <span class="preco" *ngIf="!sugestao.gratuito"
                  >R$ {{ sugestao.preco | number: '1.2-2' }}</span
                >
                <span class="preco preco--gratis" *ngIf="sugestao.gratuito">Grátis</span>
                <button class="btn-ver">Ver curso</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Sidebar -->
    <aside class="curso-detalhe__sidebar">
      <div class="sidebar-card">
        <!-- Preço -->
        <div class="sidebar-card__preco">
          <span *ngIf="curso.gratuito" class="sidebar-card__preco-gratis">Gratuito</span>
          <ng-container *ngIf="!curso.gratuito">
            <span class="sidebar-card__preco-valor">R$ {{ curso.preco | number: '1.2-2' }}</span>
            <span *ngIf="curso.precoOriginal" class="sidebar-card__preco-original">
              R$ {{ curso.precoOriginal | number: '1.2-2' }}
            </span>
          </ng-container>
        </div>

        <!-- Botão Principal -->
        <button class="btn btn--primary btn--block" *ngIf="!inscrito()" (click)="inscreverCurso()">
          {{ curso.gratuito ? 'Inscrever-se grátis' : 'Comprar curso' }}
        </button>

        <button class="btn btn--success btn--block" *ngIf="inscrito()" (click)="continuarCurso()">
          <app-header-icone nome="play" [tamanho]="18"></app-header-icone>
          Continuar assistindo
        </button>

        <!-- O que está incluso -->
        <div class="sidebar-card__inclui">
          <h4>Este curso inclui:</h4>
          <ul class="sidebar-card__lista">
            <li *ngFor="let item of curso.inclui">
              <app-header-icone nome="check" [tamanho]="14" cor="#22c55e"></app-header-icone>
              {{ item }}
            </li>
          </ul>
        </div>

        <!-- Informações -->
        <div class="sidebar-card__info">
          <div class="info-item">
            <app-header-icone nome="cursos" [tamanho]="18"></app-header-icone>
            <div>
              <span class="info-item__label">Aulas</span>
              <span class="info-item__valor">{{ totalAulas }} aulas</span>
            </div>
          </div>
          <div class="info-item">
            <app-header-icone nome="relogio" [tamanho]="18"></app-header-icone>
            <div>
              <span class="info-item__label">Duração</span>
              <span class="info-item__valor">{{ curso.duracao }}</span>
            </div>
          </div>
          <div class="info-item">
            <app-header-icone nome="grafico" [tamanho]="18"></app-header-icone>
            <div>
              <span class="info-item__label">Nível</span>
              <span class="info-item__valor">{{ getNivelLabel(curso.nivel) }}</span>
            </div>
          </div>
          <div class="info-item" *ngIf="curso.certificado">
            <app-header-icone nome="certificados" [tamanho]="18"></app-header-icone>
            <div>
              <span class="info-item__label">Certificado</span>
              <span class="info-item__valor">incluso</span>
            </div>
          </div>
          <div class="info-item">
            <app-header-icone nome="calendario" [tamanho]="18"></app-header-icone>
            <div>
              <span class="info-item__label">Atualizado</span>
              <span class="info-item__valor">{{ formatarData(curso.atualizado) }}</span>
            </div>
          </div>
        </div>

        <!-- Instrutor -->
        <div class="sidebar-card__instrutor">
          <h4>Instrutor</h4>
          <div class="instrutor">
            <img
              [src]="curso.instrutor.avatar"
              [alt]="curso.instrutor.nome"
              class="instrutor__avatar"
            />
            <div class="instrutor__info">
              <span class="instrutor__label">Instrutor</span>
              <span class="instrutor__nome">{{ curso.instrutor.nome }}</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</app-sistema-layout>
